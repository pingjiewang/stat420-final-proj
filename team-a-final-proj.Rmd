---
title: 'Building a price prediction model for eBay Germany Used Car listings'
author: "Richa Gupta/Sandro Tanis/Ping Wang"
course: "STAT 420, Summer 2020"
date: 'Aug 07, 2020'
output:
  html_document: 
    theme: readable
    toc: yes  
  pdf_document: default
urlcolor: cyan
---

***

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
library(knitr)
opts_chunk$set(cache = TRUE, autodep = TRUE)
```

# 1. Introduction

# 2. Methods

## 2.1 Data cleanning and exploration

Loading for raw data
```{r,warning=FALSE,message=FALSE}
library(readr)
autos_raw <- read_csv("autos.csv")
str(autos_raw)
```


## 2.1.1 Data cleaning and preparation

```{r}
autos=subset(autos_raw, price>0)
columns_remove=c("postalCode","lastSeen", "nrOfPictures","dateCreated","dateCrawled","monthOfRegistration")   
columns_numeric = c("price","powerPS", "kilometer")
columns_factor = c("seller","offerType","abtest","vehicleType","gearbox","model","brand","fuelType","notRepairedDamage" )
other_columns = c("name","yearOfRegistration" ) 

#autos[,columns_factor]=lapply(autos[,columns_factor], as.factor)
autos = autos[, -which(names(autos) %in% columns_remove)]

str(autos)

```

## 2.1.2 Data exploration to find the relationship between continous variables

```{r}
library(dplyr)
autos=na.omit(autos)
autos_factor_groups=autos %>% count (seller,offerType,abtest,vehicleType,gearbox,model,brand,fuelType,notRepairedDamage)
autos_factor_groups=autos_factor_groups[order(autos_factor_groups$n,decreasing = TRUE),]
group1=autos_factor_groups[1,]
group1.size = group1$n
group1=subset(group1, select = -c(n) )

autos_1=autos
cols=names(group1)
for (i in 1:ncol(group1)){
  idx = autos_1[,cols[i]]==group1[[i]]
  autos_1=autos_1[idx,]
}

autos_1=subset(autos_1, select = columns_numeric )
  

#
pairs(autos_1,col="dodgerblue")
```

### Autos_1 has been isolated to better find a model format for continuous variables

Please use **autos_1** for determining box-cox tranformations,it only contains continuous variables 

```{r}
####RICHA####
#head(autos,100)
nrow(autos_1) #3711 rows

int_model = lm(price ~ powerPS * kilometer , data = autos_1)
plot(price ~ powerPS * kilometer, data = autos_1, col = "grey", pch = 20, cex = 1.5, main = "")
abline(int_model, col = "darkorange", lwd = 2)
#fitted vs residual
plot(fitted(int_model), resid(int_model), col = "grey", pch = 20,
     xlab = "Fitted", ylab = "Residuals", main = "Fitted versus Residuals")
abline(h = 0, col = "darkorange", lwd = 2)

#qqplot
qqnorm(resid(int_model), main = "Normal Q-Q Plot", col = "darkgrey")
qqline(resid(int_model), col = "dodgerblue", lwd = 2)

library(MASS)
boxcox(int_model, plotit = TRUE, lambda = seq(-0.5, 2.0, by = 0.1))

#finding large leverage
mod_lev = hatvalues(int_model)
mod_lev_mean = mean(mod_lev)
high_lev = mod_lev[mod_lev > 2 * mod_lev_mean]
length(high_lev)
head(high_lev)

#finding influenctial
mod_cook = cooks.distance(int_model)
high_infl = mod_cook[mod_cook > 4 / length(mod_cook)]
head(high_infl)
length(high_infl)

#Refit the multiple regression model without any influential points
int_model_sub = lm(price ~ powerPS * kilometer , data = autos_1, subset = mod_cook <= 4 / length(mod_cook))
(coef(int_model) - coef(int_model_sub)) / coef(int_model)
```


#### It seems that there are violations of both the normality and equal variance assumptions. Therefore we will proceed to perform a Box-cot transformation

## 2.1.2 perform box-cox tranformation on continuous variables only (to estabish transformation form )
 Eg. model = lm(xxx(price)~powerPS+kilometer)





#### check for colinearity

#### check for violation of model assumption
  QQplot, fitted vs residual
  BP test, Sharpio.wilk test

## 2.1.3 combine continous variables(wiht established form) with all factor varible to start a backward AIC to find a good model.
  model_aim_start = lm(log(price)~powerPS+kilometer+(factor varilable)^2,

##  2.1.4 remove high influence data and refit the choose model


TEST result?

LOOC_RMSE
CV 




















# 3. Results

# 4. Discussion

# 5. Appendix




